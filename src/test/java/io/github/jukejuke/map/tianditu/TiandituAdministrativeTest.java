package io.github.jukejuke.map.tianditu;

import okhttp3.OkHttpClient;
import okhttp3.mockwebserver.MockResponse;
import okhttp3.mockwebserver.MockWebServer;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

public class TiandituAdministrativeTest {
    private MockWebServer mockWebServer;
    private TiandituAdministrative administrativeService;

    @BeforeEach
    void setUp() throws Exception {
        // 启动MockWebServer
        mockWebServer = new MockWebServer();
        mockWebServer.start();

        // 创建TiandituAdministrative实例并替换基础URL
        administrativeService = new TiandituAdministrative.Builder("")
                .httpClient(new OkHttpClient())
                .build();
    }

    @AfterEach
    void tearDown() throws Exception {
        // 关闭MockWebServer
        mockWebServer.shutdown();
    }

    @Test
    void queryAdministrative_ShouldParseResponseCorrectly() throws Exception {
        // 准备模拟成功响应数据
        String mockJsonResponse = "{\"status\": 200, \"message\": \"成功\", \"data\": {\"suggestion\": [], \"district\": [{\"gb\": \"156110000\", \"pgb\": \"156000000\", \"name\": \"北京市\", \"boundary\": \"MULTIPOLYGON(((116.666886 40.976711,116.681259 40.944229,116.710823 40.93206,116.711319 40.909203,116.715507 40.900963,116.776962 40.872479,116.785362 40.862854,116.785286 40.849144,116.79158 40.842724,116.838028 40.838017,116.880509 40.799666,116.891601 40.779549,116.912651 40.772614,116.920586 40.746983,116.941558 40.725147,116.994232 40.692959,117.140663 40.701801,117.26104 40.671062,117.305985 40.653904,117.32103 40.655197,117.339477 40.665627,117.37056 40.675072,117.401886 40.679695,117.488243 40.670795,117.498841 40.663986,117.506111 40.657089,117.498983 40.645776,117.495224 40.636768,117.484673 40.635494,117.469963 40.637451,117.446434 40.652283,117.436157 40.649628,117.418846 40.619831,117.437309 40.589046,117.438667 40.580124,117.4338 40.576275,117.373818 40.564884,117.334015 40.576622,117.299759 40.577332,117.235344 40.546467,117.234886 40.533897,117.247383 40.52467,117.249382 40.516888,117.208496 40.512817,117.195091 40.496902,117.223061 40.453522,117.229744 40.436108,117.216019 40.374433,117.218529 40.366924,117.235115 40.366592,117.245727 40.356312,117.251366 40.334423,117.266289 40.330112,117.263306 40.323811,117.267281 40.305901,117.284859 40.295288,117.287178 40.276382,117.300446 40.277046,117.319351 40.286003,117.323662 40.275059,117.322441 40.261974,117.340088 40.234875,117.350189 40.229099,117.379738 40.226872,117.385635 40.21899,117.370071 40.216515,117.370781 40.208378,117.384926 40.202366,117.372192 40.199184,117.375374 40.1861,117.389519 40.190697,117.399422 40.185391,117.386337 40.173367,117.344254 40.171246,117.353096 40.154625,117.342842 40.146488,117.342842 40.142601,117.348854 40.142952,117.348854 40.138355,117.322678 40.131283,117.315254 40.138,117.304642 40.137295,117.289085 40.119259,117.275642 40.118904,117.267159 40.103699,117.242401 40.114307,117.230728 40.109356,117.216942 40.093086,117.20385 40.094147,117.202087 40.080002,117.184135 40.070721,117.182335 40.081257,117.177795 40.082603,117.165383 40.071247,117.148216 40.076267,117.14846 40.066841,117.131043 40.062004,117.111236 40.07019,117.098824 40.069134,117.095123 40.073624,117.07769 40.073097,117.076637 40.066494,117.061577 40.065437,117.062111 40.062004,117.044151 40.057777,117.045471 40.051437,117.029884 40.045891,117.01844 40.036003,117.016945 40.028194,116.991585 40.030045,116.978912 40.036648,116.962799 40.034008,116.961738 40.041401,116.95533 40.045658,116.865257 40.040291,116.834869 40.043587,116.797821 40.029987,116.760254 40.027573,116.751572 40.020969,116.755333 40.014852,116.771263 40,116.756104 39.966316,116.758469 39.959972,116.774513 39.94735,116.78022 39.892586,116.794525 39.878544,116.803215 39.876938,116.825226 39.87682,116.836906 39.861332,116.873741 39.848312,116.889122 39.836117,116.901245 39.837566,116.905548 39.848198,116.915399 39.846959,116.942055 39.792229,116.946205 39.772968,116.941383 39.768208,116.928085 39.771988,116.902069 39.75917,116.899635 39.755074,116.90654 39.741055,116.885475 39.720871,116.894295 39.696308,116.899353 39.677956,116.868164 39.673187,116.84726 39.662148,116.831207 39.63802,116.818809 39.630886,116.830963 39.620438,116.827736 39.615311,116.818169 39.612881,116.81292 39.61721,116.804947 39.613979,116.783486 39.608093,116.782913 39.594227,116.771706 39.591381,116.766579 39.603916,116.755371 39.611511,116.741127 39.617969,116.73011 39.613602,116.719688 39.621721,116.693268 39.619297,116.694786 39.608475,116.718529 39.59594,116.719475 39.59119,116.704475 39.586063,116.659897 39.6035,116.646675 39.598209,116.630806 39.6035,116.621216 39.598537,116.613609 39.600193,116.600052 39.623337,116.558724 39.618565,116.561691 39.609661,116.552788 39.598381,116.534378 39.59185,116.520729 39.597786,116.517372 39.59462,116.514313 39.584568,116.520134 39.572258,116.501137 39.5592,116.500542 39.549702,116.493416 39.547325,116.463738 39.553261,116.470856 39.533077,116.432274 39.522392,116.436424 39.508144,116.426331 39.505768,116.415649 39.514675,116.413864 39.523579,116.394279 39.526546,116.395462 39.512894,116.409119 39.50399,116.413277 39.49271,116.404366 39.48024,116.420395 39.474304,116.428711 39.480835,116.435829 39.479649,116.441177 39.476086,116.447013 39.452848,116.444145 39.44759,116.429603 39.443493,116.382111 39.453316,116.344795 39.448544,116.298714 39.482639,116.243736 39.504768,116.237986 39.51603,116.235123 39.5499,116.237907 39.55714,116.218079 39.565784,116.214266 39.575841,116.200966 39.576511,116.195427 39.584835,116.180077 39.589596,116.169502 39.584003,116.147034 39.584503,116.14154 39.571018,116.131912 39.568424,116.102272 39.568955,116.098106 39.576908,116.084808 39.572132,116.025185 39.570019,116.0177 39.574017,116.015999 39.583244,116.008591 39.584305,115.998718 39.575512,115.988235 39.575512,115.984741 39.591492,115.972252 39.59399,115.969261 39.589996,115.971207 39.570484,115.949341 39.560028,115.923203 39.591873,115.903236 39.598526,115.899437 39.58807,115.901337 39.58284,115.90799 39.581417,115.907211 39.574467,115.898483 39.564781,115.883278 39.567158,115.886131 39.554798,115.881851 39.550995,115.866165 39.544819,115.847626 39.552898,115.840027 39.549095,115.839073 39.542442,115.821014 39.538639,115.814835 39.529133,115.822914 39.507744,115.820534 39.505367,115.805328 39.508694,115.766884 39.507528,115.750107 39.51173,115.717155 39.56152,115.704155 39.560211,115.691658 39.566181,115.681663 39.599796,115.660873 39.607388,115.647247 39.598305,115.628433 39.602848,115.623894 39.596359,115.611572 39.602196,115.597946 39.60025,115.583031 39.593765,115.57914 39.587925,115.571998 39.587925,115.564865 39.589874,115.556435 39.605442,115.537407 39.615486,115.506485 39.589226,115.505837 39.608036,115.516212 39.618416,115.514915 39.637875,115.491562 39.650848,115.47081 39.648254,115.472107 39.658634,115.483131 39.667713,115.47924 39.672256,115.481186 39.680687,115.492211 39.690418,115.485726 39.698853,115.484428 39.735828\", \"center\": {\"lng\": 116.718412, \"lat\": 39.903857}, \"level\": 4}]}}";

        // 配置模拟响应
        mockWebServer.enqueue(new MockResponse()
                .setResponseCode(200)
                .setHeader("Content-Type", "application/json")
                .setBody(mockJsonResponse));

        // 执行测试方法
        TiandituAdministrative.TiandituAdministrativeResponse response = administrativeService.queryAdministrative("156110000");

        // 验证响应结果
        assertNotNull(response);
        assertEquals(200, response.getStatus());
        assertEquals("成功", response.getMessage());
        assertNotNull(response.getData());
        assertNotNull(response.getData().getDistrict());
        assertEquals(1, response.getData().getDistrict().length);
        assertEquals("156110000", response.getData().getDistrict()[0].getGb());
        assertEquals("156000000", response.getData().getDistrict()[0].getPgb());
        assertEquals("北京市", response.getData().getDistrict()[0].getName());
        assertEquals(4, response.getData().getDistrict()[0].getLevel());
        assertNotNull(response.getData().getDistrict()[0].getCenter());
        assertEquals(116.718412, response.getData().getDistrict()[0].getCenter().getLng());
        assertEquals(39.903857, response.getData().getDistrict()[0].getCenter().getLat());
    }

    @Test
    void queryAdministrative_WithInvalidParameters_ShouldHandleError() throws Exception {
        // 准备模拟错误响应数据
        String mockErrorResponse = "{\"status\": 400, \"message\": \"请求参数非法长度或不合规\", \"data\": null}";

        // 配置模拟响应
        mockWebServer.enqueue(new MockResponse()
                .setResponseCode(400)
                .setHeader("Content-Type", "application/json")
                .setBody(mockErrorResponse));

        // 执行测试方法
        TiandituAdministrative.TiandituAdministrativeResponse response = administrativeService.queryAdministrative("");

        // 验证错误响应
        assertNotNull(response);
        assertEquals(400, response.getStatus());
        assertEquals("请求参数非法长度或不合规", response.getMessage());
        assertNull(response.getData());
    }
}